<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Product Calculation</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    .container {
      width: 80%;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    input {
      padding: 10px;
      margin: 10px;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: calc(100% - 22px);
    }
    .input-group {
      display: flex;
      flex-direction: column;
      margin-bottom: 20px;
    }
    #outputTable {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    #outputTable th, #outputTable td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    #outputTable th {
      background-color: #f2f2f2;
    }
    #totalOutput {
      font-size: 1.2em;
      font-weight: bold;
      margin-top: 10px;
    }
    #productChart {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    #productChart th, #productChart td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
    }
    #productChart th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>

  <div class="container">
    <h1>Product Calculation</h1>

    <table id="outputTable">
      <thead>
        <tr>
          <th>Product Name</th>
          <th>Quantity</th>
          <th>Rate</th>
          <th>Discount</th>
          <th>Net Rate</th>
          <th>Total</th>
        </tr>
      </thead>
      <tbody id="output"></tbody>
    </table>

    <div class="input-group">
      <input type="text" id="productInput" placeholder="Type product code (Q P R D format)" onkeydown="handleEnter(event)">
    </div>

    <h2>Product Code Reference</h2>
    <table id="productChart">
      <thead>
        <tr>
          <th>Product Code</th>
          <th>Product Name</th>
          <th>Unit</th>
          <th>Rate (₹)</th>
        </tr>
      </thead>
      <tbody id="productChartBody"></tbody>
    </table>
  </div>

  <script>
    const products = {
      "b": ["Gypblock Board 6'x4'x12mm", "nos", 330],
      "ib": ["Gypsum Board 6'x4'x12.5mm", "nos", 430],
      "pt": ["Patti 8'", "nos", 70],
      "mpt": ["Magnic Ceiling Section 2440mm", "nos", 105],
      "xpt": ["Xpert Ceiling Section 2440mm", "nos", 130],
      "bt": ["Bottom 8'", "nos", 70],
      "mbt": ["Magnic Intermediate 2440mm", "nos", 105],
      "xpt": ["Xpert Intermediate 2440mm", "nos", 130],
      "pe": ["Perameter 8'", "nos", 45],
      "mpe": ["Magnic Perameter 2440mm", "nos", 60],
      "xpe": ["Xpert Perameter 2440mm", "nos", 95],
      "al": ["AL 8'", "nos", 25],
      "mal": ["Magnic Ceiling Angle 2440mm", "nos", 38],
      "xal": ["Xpert Ceiling Angle 2440mm", "nos", 50],
      "xp": ["Gypsum Plaster", "bg", 160],
      "vp": ["Vita Gypsum Plaster", "bg", 200],
      "jc": ["Easi Fill Jointing Compound", "bg", 550],
      "ds1": ["Drywall Screw 1inch 700 nos", "pkt", 200],
      "ds1.5": ["Drywall Screw 1.5inch 500 nos", "pkt", 200],
      "rp": ["Fasterner Rawl Plug 100 nos", "pkt", 300],
      "ft": ["Fiber Tape", "roll", 100],
      "t": ["Transport", "", 0],
      "l": ["Labour", "", 0]
    };

    let total = 0;
    let totalDiscount = 0;
    let history = [];

    function addProduct() {
      let input = document.getElementById("productInput").value.trim();

      if (input === "c") {
        clearAll();
        return;
      }

      if (input === "b") {
        removeLastProduct();
        return;
      }

      if (input === "t") {
        calculateTotal();
        return;
      }

      if (input === "p") {
        generatePDF();
        return;
      }

      const [quantity, productCode, rate, discount] = input.split(" ");
      const q = parseInt(quantity);
      const r = parseInt(rate);
      const d = parseInt(discount) || 0;

      if (!products[productCode]) {
        alert("Invalid product code!");
        clearInput();
        return;
      }

      const productDetails = products[productCode];
      const productName = productDetails[0];
      const unit = productDetails[1];
      const pricePerUnit = r || productDetails[2];
      const netRate = pricePerUnit - d;
      const finalAmount = q * netRate;

      total += finalAmount;
      totalDiscount += d * q;
      history.push({ name: productName, quantity: `${q} ${unit}`, pricePerUnit, discount: d, netRate, finalAmount });

      updateTable();
      clearInput();
    }

    function updateTable() {
      const outputTableBody = document.getElementById("output");
      outputTableBody.innerHTML = history.map(item => {
        return `<tr>
                  <td>${item.name}</td>
                  <td>${item.quantity}</td>
                  <td>₹${item.pricePerUnit}</td>
                  <td>₹${item.discount}</td>
                  <td>₹${item.netRate}</td>
                  <td>₹${item.finalAmount}</td>
                </tr>`;
      }).join("");
    }

    function removeLastProduct() {
      if (history.length === 0) {
        alert("No items to remove!");
        clearInput();
        return;
      }

      const lastItem = history.pop();
      total -= lastItem.finalAmount;
      totalDiscount -= lastItem.discount * parseInt(lastItem.quantity);

      updateTable();
      clearInput();
    }

    function calculateTotal() {
      const outputTableBody = document.getElementById("output");
      const totalRow = `<tr>
                          <td colspan="3"><strong></strong></td>
                          <td><strong>Discount: ₹${totalDiscount}</strong></td>
                          <td colspan="2"><strong>Total: ₹${total}</strong></td>
                        </tr>`;
      outputTableBody.insertAdjacentHTML('beforeend', totalRow);
    }

    function clearInput() {
      const input = document.getElementById("productInput");
      input.value = "";
      input.focus();
    }

    function clearAll() {
      total = 0;
      totalDiscount = 0;
      history = [];
      document.getElementById("output").innerHTML = "";
    }

    function generatePDF() {
      const pdfContent = history.map(item => `${item.name} - ${item.quantity} - ₹${item.pricePerUnit} - ₹${item.discount} - ₹${item.netRate} - ₹${item.finalAmount}`).join("\n");
      const totalContent = `Total Discount: ₹${totalDiscount}\nTotal Amount: ₹${total}`;

      const fullContent = `${pdfContent}\n\n${totalContent}`;
      const blob = new Blob([fullContent], { type: "text/plain" });
      const link = document.createElement("a");
      link.href = URL.createObjectURL(blob);
      link.download = "ThermalPrinterOutput.txt";
      link.click();
    }

    function handleEnter(event) {
      if (event.key === "Enter") {
        addProduct();
      }
    }

    window.onload = function() {
      const productChartBody = document.getElementById('productChartBody');
      const productRows = Object.entries(products).map(([code, details]) => {
        return `<tr>
                  <td>${code}</td>
                  <td>${details[0]}</td>
                  <td>${details[1]}</td>
                  <td>₹${details[2]}</td>
                </tr>`;
      }).join("");
      productChartBody.innerHTML = productRows;
    };
  </script>
</body>
</html>
