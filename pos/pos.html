<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Thermal Printer Bill</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    .container {
      width: 90%;
      margin: 0 auto;
      padding: 20px;
    }
    h1 {
      text-align: center;
    }
    input {
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
      border: 1px solid #ccc;
      width: calc(100% - 22px);
    }
    .input-group {
      margin-bottom: 20px;
    }
    #outputTable {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 20px;
    }
    #outputTable th, #outputTable td {
      border: 1px solid #ddd;
      padding: 8px;
      text-align: left;
      word-wrap: break-word;
      white-space: normal;
    }
    #outputTable th {
      background-color: #f2f2f2;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Thermal Printer Bill</h1>

    <!-- Table Section -->
    <table id="outputTable">
      <thead>
        <tr>
          <th>Product Name</th>
          <th>Quantity</th>
          <th>Rate (₹)</th>
          <th>Total (₹)</th>
        </tr>
      </thead>
      <tbody id="output"></tbody>
    </table>

    <!-- Input Section -->
    <div class="input-group">
      <input type="text" id="productInput" placeholder="Type product code (QPA format)" onkeydown="handleEnter(event)">
      <button onclick="generateImprovedPDF()">Generate PDF</button>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    const products = {
      "b": ["GYPBLOCK BOARD 6'x4'x12mm", "nos", 330],
      "ib": ["GYPSUM BOARD 6'x4'x12.5mm", "nos", 430],
      "pt": ["PATTI 8'", "nos", 70],
      "mpt": ["MAGNIC PATTI 2440mm", "nos", 105],
      "xpt": ["XPERT PATTI 2440mm", "nos", 130],
      "bt": ["BOTTOM 8'", "nos", 70],
      "pe": ["PERIMETER 8'", "nos", 45],
      "gp": ["GYPSUM PLASTER", "bg", 160],
      "vp": ["VITA GYPSUM PLASTER", "bg", 200],
      "jc": ["JOINTIONG COMPOUND", "bg", 550],
      "l": ["LOADING", "", 0],
      "u": ["UNLOADING", "", 0],
      "lu": ["LOADING & UNLOADING", "", 0],
      "t": ["TRANSPORT", "", 0],
    };

    let total = 0;
    let history = [];

    function addProduct() {
      const input = document.getElementById("productInput").value.trim().replace(/ /g, '*');
      if (input === "c") {
        clearAll();
        return;
      }

      const [quantityStr, productCode, amountStr] = input.split("*");
      const quantity = quantityStr ? parseInt(quantityStr) : 10; // Default quantity is 10
      const amount = amountStr ? parseInt(amountStr) : 0;

      if (!products[productCode]) {
        alert("Invalid product code!");
        clearInput();
        return;
      }

      if (quantity === 0) {
        removeProduct(productCode);
        clearInput();
        return;
      }

      const productDetails = products[productCode];
      const productName = productDetails[0];
      const pricePerUnit = amount === 0 ? productDetails[2] : amount;
      const displayQuantity = quantity > 1 ? `${quantity} nos` : ""; // Fixed quantity logic
      const finalAmount = quantity * pricePerUnit;

      const existingIndex = history.findIndex(item => item.code === productCode);
      if (existingIndex !== -1) {
        const existingItem = history[existingIndex];
        total -= existingItem.finalAmount;
        history[existingIndex] = { code: productCode, name: productName, quantity, displayQuantity, pricePerUnit, finalAmount };
      } else {
        history.push({ code: productCode, name: productName, quantity, displayQuantity, pricePerUnit, finalAmount });
      }

      total += finalAmount;

      renderTable();
      clearInput();
    }

    function removeProduct(productCode) {
      const productIndex = history.findIndex(item => item.code === productCode);
      if (productIndex === -1) {
        alert("Product not found!");
        return;
      }

      const removedItem = history.splice(productIndex, 1)[0];
      total -= removedItem.finalAmount;

      renderTable();
    }

    function renderTable() {
      const outputTableBody = document.getElementById("output");
      outputTableBody.innerHTML = "";

      history.forEach(item => {
        const row = `
          <tr>
            <td>${item.name}</td>
            <td>${item.displayQuantity}</td>
            <td>₹${item.pricePerUnit}</td>
            <td>₹${item.finalAmount}</td>
          </tr>`;
        outputTableBody.insertAdjacentHTML("beforeend", row);
      });

      const totalRow = `
        <tr>
          <td colspan="3" style="text-align: right; font-weight: bold;">Total</td>
          <td style="font-weight: bold;">₹${total}</td>
        </tr>`;
      outputTableBody.insertAdjacentHTML("beforeend", totalRow);
    }

    function clearAll() {
      total = 0;
      history = [];
      document.getElementById("output").innerHTML = "";
    }

    function clearInput() {
      const input = document.getElementById("productInput");
      input.value = "";
      input.focus();
    }

    async function generateImprovedPDF() {
      const { jsPDF } = window.jspdf;

      const doc = new jsPDF({
        orientation: "portrait",
        unit: "mm",
        format: [80, 150 + history.length * 10],
      });

      doc.setFontSize(10);
      doc.setFont("helvetica", "bold");
      doc.text("SAMPLE BILL", 40, 10, { align: "center" });
      doc.text(".......................", 40, 11, { align: "center" });

      doc.setFontSize(8);
      doc.text(`Date: ${new Date().toLocaleDateString()}`, 1, 18);

      let y = 25;
      doc.setFontSize(8);
      doc.text("Product Name", 1, y);
      doc.text("Qty", 47, y);
      doc.text("Rate", 60, y);
      doc.text("Total", 70, y);
      doc.text("..........................................................................................................", 0, y + 1.2);

      history.forEach(item => {
        y += 5;
        doc.text(item.name, 1, y);
        doc.text(item.displayQuantity, 47, y);
        doc.text(`${item.pricePerUnit}`, 60, y);
        doc.text(`${item.finalAmount}`, 70, y);
      });

      y += 5;
      doc.text("..........................................................................................................", 0, y - 3.2);
      doc.setFont("helvetica", "bold");
      doc.text("Total", 60, y);
      doc.text(`${total}`, 70, y);
     
      doc.text("..........................................................................................................", 0, y + 7);


      doc.save("Thermal_Printer_Bill.pdf");
    }

    function handleEnter(event) {
      if (event.key === "Enter") {
        addProduct();
      }
    }
  </script>
</body>
</html>